<?php
//----------------------------------------------------------------------------------------------------
// ZERONEED PHP WEB FRAMEWORK 
//----------------------------------------------------------------------------------------------------
//
// Author     : Ozan UYKUN <ozanbote@windowslive.com> | <ozanbote@gmail.com>
// Site       : www.znframework.com
// License    : The MIT License
// Copyright  : Copyright (c) 2012-2016, ZN Framework
//
//----------------------------------------------------------------------------------------------------

//----------------------------------------------------------------------------------------------------
// Start Micro Time
//----------------------------------------------------------------------------------------------------
$start = microtime();
//----------------------------------------------------------------------------------------------------

//----------------------------------------------------------------------------------------------------
// REAL_BASE_DIR
//----------------------------------------------------------------------------------------------------
define('REAL_BASE_DIR', realpath(__DIR__).DIRECTORY_SEPARATOR);

//----------------------------------------------------------------------------------------------------
// INTERNAL_DIR
//----------------------------------------------------------------------------------------------------
//
// @return Internal/
//
//----------------------------------------------------------------------------------------------------
define('INTERNAL_DIR', 'Internal/'); 

//----------------------------------------------------------------------------------------------------
// CORE_DIR
//----------------------------------------------------------------------------------------------------
//
// @return Internal/Core/
//
//----------------------------------------------------------------------------------------------------
define('CORE_DIR', INTERNAL_DIR.'Core/'); 

//----------------------------------------------------------------------------------------------------
// Base
//----------------------------------------------------------------------------------------------------
require_once CORE_DIR.'Base.php';
//----------------------------------------------------------------------------------------------------

//----------------------------------------------------------------------------------------------------
// Require Applications Config File
//----------------------------------------------------------------------------------------------------

$application = require_once APPLICATIONS_DIR.'Applications.php';
//----------------------------------------------------------------------------------------------------

//----------------------------------------------------------------------------------------------------
// Preloading
//----------------------------------------------------------------------------------------------------
require_once CORE_DIR.'Preloading.php';
//----------------------------------------------------------------------------------------------------

//----------------------------------------------------------------------------------------------------
// Application Directory
//----------------------------------------------------------------------------------------------------
$appdir = $application['directory']['others'];

if( is_array($appdir) && ! empty($appdir[host()]) )
{
	$appdir = $appdir[host()];
}
elseif( defined('URIAPPDIR') )
{
	$flip   = array_flip($appdir);
	$appdir = URIAPPDIR;
			
	if( ! empty($flip[URIAPPDIR]) )
	{
		define('CURRENT_URIAPPDIR', $flip[URIAPPDIR]);
	}
}
elseif( is_array($appdir) )
{
	$appdir = $application['directory']['default'];	
}

//----------------------------------------------------------------------------------------------------
// Applications Directories
//----------------------------------------------------------------------------------------------------
define('APPDIR', suffix(APPLICATIONS_DIR.$appdir));
//----------------------------------------------------------------------------------------------------

if( ! is_dir(APPDIR) )
{
	trace('["'.$appdir.'"] Application Directory Not Found!');
}

//----------------------------------------------------------------------------------------------------
// Internal Hierarchy -- Internal/Core/Hierarchy.php
//----------------------------------------------------------------------------------------------------
require_once HIERARCHY_DIR; 
//----------------------------------------------------------------------------------------------------
	
//----------------------------------------------------------------------------------------------------
// Finish Micro Time
//----------------------------------------------------------------------------------------------------
$finish = microtime();
//----------------------------------------------------------------------------------------------------
	
if( Config::get('Application', 'benchmark') === true ) 
{
	//------------------------------------------------------------------------------------------------
	// System Elapsed Time Calculating
	//------------------------------------------------------------------------------------------------
	$elapsedTime = $finish - $start;
	//------------------------------------------------------------------------------------------------

	//------------------------------------------------------------------------------------------------
	// Get Memory Usage
	//------------------------------------------------------------------------------------------------
	$memoryUsage = memory_get_usage();
	//------------------------------------------------------------------------------------------------

	//------------------------------------------------------------------------------------------------
	// Get Maximum Memory Usage
	//------------------------------------------------------------------------------------------------
	$maxMemoryUsage = memory_get_peak_usage();
	//------------------------------------------------------------------------------------------------

	//------------------------------------------------------------------------------------------------
	// Template Benchmark Performance Result Table
	//------------------------------------------------------------------------------------------------
	$benchmarkData = 
	[
		'elapsedTime'	 => $elapsedTime,
		'memoryUsage'	 => $memoryUsage,
		'maxMemoryUsage' => $maxMemoryUsage
	];	

	$benchResult = Import::template('BenchmarkTable', $benchmarkData, true);
	//------------------------------------------------------------------------------------------------

	//------------------------------------------------------------------------------------------------
	// Get Benchmark Performance Result Table
	//------------------------------------------------------------------------------------------------
	internalBenchmarkReport($benchResult);
	//------------------------------------------------------------------------------------------------
}	